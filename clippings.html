<html>
    <head>
        <script>
            var GITHUB = {
                "endpoint": "https://api.github.com/repos/USER_NAME/REPO/contents/Inbox/Clippings/",
                "token": "TOKEN",
                "commiterName": "USER_NAME",
                "commiterEmail": "USER_EMAIL"
            };
            var LAMBDA_URL = "ENDPOINT";
            var CLIPPINGS_PATH;
            if (navigator.vendor == "Apple Inc.") {
                CLIPPINGS_PATH = "file:///mnt/us//documents//My Clippings.txt";
            } else {
                CLIPPINGS_PATH = "http://localhost/My Clippings.txt";
            }
        </script>
    </head>
    <body>
        <div id="r" style="font-size: 100px;">Uploading...</div>
        <script>
            (function () {
                var rawFile = new XMLHttpRequest();
                rawFile.open("GET", CLIPPINGS_PATH, false);
                rawFile.onreadystatechange = function () {
                    if( rawFile.readyState === 4 && (rawFile.status === 200 || rawFile.status == 0) ) {
                        var lambdaReq = new XMLHttpRequest();
                        lambdaReq.open("POST", LAMBDA_URL, true);
                        lambdaReq.onreadystatechange = function () {
                            if ( lambdaReq.readyState === 4 && (lambdaReq.status === 200 || lambdaReq.status == 0) ) {
                                var githubReq = new XMLHttpRequest();
                                var timestamp = new Date().valueOf();
                                githubReq.open("PUT", GITHUB.endpoint + timestamp + ".md", true);
                                githubReq.setRequestHeader("Accept", "application/vnd.github+json");
                                githubReq.setRequestHeader("Authorization", "Bearer " + GITHUB.token);
                                githubReq.send(JSON.stringify({ "message": "Kindle clippings " + timestamp, "committer": { "name": GITHUB.commiterName, "email": GITHUB.commiterEmail },"content": lambdaReq.responseText }));
                                var div = document.getElementById("r");
                                div.innerText = "Done!";
                            }
                        }
                        lambdaReq.send(rawFile.responseText);
                    }
                }
                rawFile.send(null);
            })()
        </script>
    </body>
</html>
