<html>
    <head>
        <script src="file:///mnt/us//documents//vars.js"></script>
        <style>
            button {
                width: 100%;
                font-size: 80px;
            }
            #linksContainer {
                font-size: 50px;
            }
            ul {
                list-style: none;
            }
            li {
                padding: 30px;
            }
        </style>
    </head>
    <body>
        <div>
            <button id="uploadBtn" onclick="upload()">Upload clippings</button>
            <button id="cleanBtn" onclick="cleanLinks()">Clean HN links</button>
        </div>
        <ul id="linksContainer">
            Loading Hacker News links...
        </ul>
        <script>
            // Old JS compatible with Experimental Browser

            var uploadBtn = document.getElementById("uploadBtn");
            var cleanBtn = document.getElementById("cleanBtn");
            var linksContainer = document.getElementById("linksContainer");

            (function(){loadLinks();})();
            
            function loadLinks() {
                var hnLinksReq = new XMLHttpRequest();
                hnLinksReq.open("GET", APPSCRIPT_URL);
                hnLinksReq.onload  = function() {
                    linksContainer.innerText = "";
                    var hnLinks = JSON.parse(hnLinksReq.responseText);
                    if(hnLinks[0][0]) {
                        for(var i = hnLinks.length - 1; i >= 0; i--){
                            var li = document.createElement("li");
                            li.appendChild(createHnLink(hnLinks[i]));
                            linksContainer.appendChild(li);
                        }
                    } else {
                        linksContainer.innerText = "No links.";
                    }
                };
                hnLinksReq.send();
            }

            function createHnLink(hnData){
                var title = hnData[1];
                var hackerweb = HACKERWEB_PATH + "?" + hnData[0];
                var a = document.createElement('a');
                var linkText = document.createTextNode(title);
                a.appendChild(linkText);
                a.href = hackerweb;
                return a;
            }

            function cleanLinks(){
                var hnLinksCleanReq = new XMLHttpRequest();
                hnLinksCleanReq.open("GET", APPSCRIPT_URL + "?clean");
                hnLinksCleanReq.onreadystatechange = function () {
                    if( hnLinksCleanReq.readyState === 4 && (hnLinksCleanReq.status === 200 || hnLinksCleanReq.status == 0) ) {
                        msg = JSON.parse(hnLinksCleanReq.responseText).msg;
                        cleanBtn.innerText = msg;
                        loadLinks();
                    }
                };
                hnLinksCleanReq.send();
            }

            function upload () {
                var rawFile = new XMLHttpRequest();
                rawFile.open("GET", CLIPPINGS_PATH, false);
                rawFile.onreadystatechange = function () {
                    if( rawFile.readyState === 4 && (rawFile.status === 200 || rawFile.status == 0) ) {
                        uploadBtn.innerText = "Processing...";
                        var lambdaReq = new XMLHttpRequest();
                        lambdaReq.open("POST", LAMBDA_URL, true);
                        lambdaReq.onreadystatechange = function () {
                            if ( lambdaReq.readyState === 4 && (lambdaReq.status === 200 || lambdaReq.status == 0) ) {
                                uploadBtn.innerText = "Uploading...";
                                var githubReq = new XMLHttpRequest();
                                var timestamp = new Date().valueOf();
                                githubReq.open("PUT", GITHUB.endpoint + timestamp + ".md", true);
                                githubReq.setRequestHeader("Accept", "application/vnd.github+json");
                                githubReq.setRequestHeader("Authorization", "Bearer " + GITHUB.token);
                                githubReq.send(JSON.stringify({ "message": "Kindle clippings " + timestamp, "committer": { "name": GITHUB.commiterName, "email": GITHUB.commiterEmail },"content": lambdaReq.responseText }));
                                uploadBtn.innerText = "Done!";
                            }
                        }
                        lambdaReq.send(rawFile.responseText);
                    }
                }
                rawFile.send(null);
            }
        </script>
    </body>
</html>
